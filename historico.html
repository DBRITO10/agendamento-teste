<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Histórico de Ações</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #fafafa; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { color: #cc0000; font-size: 28px; margin: 10px 0 20px 0; font-weight: bold; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        thead th { background-color: #cc0000; color: white; }
        #userBar {
            background: #E6E6E6;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px;
            margin-bottom: 12px;
            flex-wrap: nowrap;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #userBar span {
            flex-shrink: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #userBar button {
            width: auto;
            flex-shrink: 0;
            margin-left: 10px;
        }
        .action-buttons-container {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .action-buttons-container button {
            background-color: #d32f2f;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: none;
        }
        .action-buttons-container button.visible {
            display: inline-block;
        }
        .action-buttons-container button:hover {
            background-color: #b71c1c;
        }
    </style>
</head>
<body>

<div id="userBar">
    <button onclick="window.location.href = 'gerenciamento.html'" style="
        background: transparent;
        border: none;
        color: #333;
        font-size: 24px;
        cursor: pointer;
        margin-right: 10px;
    ">←</button>
    <span id="welcomeUser" style="font-weight:bold; color:#333; flex-grow: 1;"></span>
    <button onclick="logout()" style="background:#CC0000; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:bold;">Sair</button>
</div>
<script>
const username = localStorage.getItem("username") || "Usuário";
document.addEventListener("DOMContentLoaded", ()=>{
    document.getElementById("welcomeUser").textContent = "Bem-vindo, " + username;
});
</script>

<header>
    <h1>Histórico de Ações</h1>
</header>

<div class="action-buttons-container">
    <button id="restoreSelectedBtn">Restaurar Selecionados</button>
    <button id="deleteSelectedBtn">Excluir Selecionados</button>
</div>

<div class="table-container">
    <table id="historicoTabela" class="display" style="width:100%">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAllCheckbox"></th>
                <th>Data</th>
                <th>Usuário</th>
                <th>Ação</th>
                <th>Detalhes</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <p id="carregando" style="text-align: center;">Carregando...</p>
</div>

<script type="module">
    import { db, auth } from "./firebase-config.js";
    import { collection, query, getDocs, orderBy, doc, deleteDoc, addDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    let historicoDataTable = null;
    const carregandoEl = document.getElementById('carregando');
    let currentUserName = null;
    let currentUserUid = null;

    onAuthStateChanged(auth, user => {
        if (user) {
            currentUserUid = user.uid;
            currentUserName = localStorage.getItem("username") || user.email;
            carregarHistorico();
        } else {
            carregandoEl.textContent = "Você precisa estar logado para ver o histórico.";
            window.location.href = "index.html";
        }
    });

    window.logout = () => {
        signOut(auth).then(() => {
            window.location.href = "index.html";
        }).catch((error) => {
            console.error("Erro ao fazer logout: ", error);
        });
    };

    async function carregarHistorico() {
        carregandoEl.textContent = 'Carregando...';
        const q = query(collection(db, "historico-acoes"), orderBy("timestamp", "desc"));
        try {
            const snapshot = await getDocs(q);
            const dadosParaTabela = [];

            if (snapshot.empty) {
                carregandoEl.textContent = 'Nenhuma ação registrada.';
            } else {
                carregandoEl.style.display = 'none';
                snapshot.forEach(doc => {
                    const acao = doc.data();
                    const dataFormatada = new Date(acao.timestamp.seconds * 1000).toLocaleString('pt-BR');

                    let acaoDisplay = acao.acao;
                    let isRestorable = false;

                    const detalhes = acao.detalhes || {};

                    if (acao.acao.includes("excluiu")) {
                        acaoDisplay = "Excluiu";
                        if (detalhes.senha || (detalhes.agendamentos && detalhes.agendamentos.length > 0)) {
                             isRestorable = true;
                        }
                    } else if (acao.acao.includes("moveu um agendamento para rascunho")) {
                        acaoDisplay = "Moveu para Rascunho";
                        if (detalhes.senha) {
                            isRestorable = true;
                        }
                    } else if (acao.acao.includes("agendou a partir de rascunho")) {
                         acaoDisplay = "Agendou a partir de rascunho";
                    } else if (acao.acao.includes("agendou")) {
                        acaoDisplay = "Agendou";
                    } else if (acao.acao.includes("restaurou")) {
                         acaoDisplay = "Restaurou";
                    } else if (acao.acao.includes("atualizou")) {
                        acaoDisplay = "Atualizou";
                    }

                    let detalhesHTML = '';
                    if (Array.isArray(detalhes.agendamentos)) {
                        detalhesHTML = "<ul>";
                        detalhes.agendamentos.forEach(item => {
                            detalhesHTML += `<li>
                                <strong>Senha:</strong> ${item.senha || 'Vazio'}<br>
                                <strong>Data:</strong> ${item.data || 'Vazio'}<br>
                                <strong>Central:</strong> ${item.central || 'Vazio'}<br>
                                <strong>Cargas:</strong> ${item.cargas || 'Vazio'}<br>
                                <strong>Pedido de Compra:</strong> ${item.pedidoCompra || 'Vazio'}<br>
                                <strong>Fornecedor:</strong> ${item.fornecedor || 'Vazio'}<br>
                                <strong>Tipo de Produto:</strong> ${item.tipoDeProduto || 'Vazio'}<br>
                                <strong>Produto:</strong> ${item.produto || 'Vazio'}<br>
                                <strong>Volumes:</strong> ${item.volumes || 'Vazio'}
                            </li>`;
                        });
                        detalhesHTML += "</ul>";
                    } else {
                         detalhesHTML = `
                            <strong>Senha:</strong> ${detalhes.senha || 'Vazio'}<br>
                            <strong>Data:</strong> ${detalhes.data || 'Vazio'}<br>
                            <strong>Central:</strong> ${detalhes.central || 'Vazio'}<br>
                            <strong>Cargas:</strong> ${detalhes.cargas || 'Vazio'}<br>
                            <strong>Pedido de Compra:</strong> ${detalhes.pedidoCompra || 'Vazio'}<br>
                            <strong>Fornecedor:</strong> ${detalhes.fornecedor || 'Vazio'}<br>
                            <strong>Tipo de Produto:</strong> ${detalhes.tipoDeProduto || 'Vazio'}<br>
                            <strong>Produto:</strong> ${detalhes.produto || 'Vazio'}<br>
                            <strong>Volumes:</strong> ${detalhes.volumes || 'Vazio'}
                        `;
                    }

                    dadosParaTabela.push([
                        `<input type="checkbox" class="historico-checkbox" data-id="${doc.id}" data-restorable="${isRestorable}" data-details='${JSON.stringify(detalhes)}'>`,
                        dataFormatada,
                        acao.username || "Desconhecido",
                        acaoDisplay,
                        detalhesHTML
                    ]);
                });
            }

            if (historicoDataTable) {
                historicoDataTable.destroy();
            }

            historicoDataTable = $('#historicoTabela').DataTable({
                data: dadosParaTabela,
                columns: [
                    { title: "<input type='checkbox' id='selectAllCheckbox'>" },
                    { title: "Data" },
                    { title: "Usuário" },
                    { title: "Ação" },
                    { title: "Detalhes" }
                ],
                paging: true,
                info: true,
                order: [[1, 'desc']],
                oLanguage: {
                    sEmptyTable: "Nenhuma ação registrada.",
                    sSearch: "Buscar:",
                    sInfo: "Mostrando _START_ a _END_ de _TOTAL_ registros",
                    sInfoEmpty: "Mostrando 0 a 0 de 0 registros"
                }
            });

            $('#selectAllCheckbox').on('click', function() {
                const isChecked = $(this).prop('checked');
                $('.historico-checkbox').prop('checked', isChecked);
                toggleButtons();
            });

            $(document).on('change', '.historico-checkbox', function() {
                toggleButtons();
            });

        } catch (e) {
            console.error("Erro ao carregar histórico: ", e);
            carregandoEl.textContent = 'Ocorreu um erro ao carregar o histórico. Tente novamente mais tarde.';
        }
    }

    function toggleButtons() {
        const checkedCount = $('.historico-checkbox:checked').length;
        const restoreButton = $('#restoreSelectedBtn');
        const deleteButton = $('#deleteSelectedBtn');

        if (checkedCount > 0) {
            let hasRestorableItem = false;
            $('.historico-checkbox:checked').each(function() {
                if ($(this).data('restorable')) {
                    hasRestorableItem = true;
                }
            });
            restoreButton.toggleClass('visible', hasRestorableItem);
            deleteButton.addClass('visible');
        } else {
            restoreButton.removeClass('visible');
            deleteButton.removeClass('visible');
        }
    }

    $('#restoreSelectedBtn').on('click', async () => {
        const checkedItems = $('.historico-checkbox:checked');
        if (checkedItems.length === 0) {
            alert('Por favor, selecione pelo menos um item para restaurar.');
            return;
        }

        const batch = writeBatch(db);
        let restoredCount = 0;
        let restoredDetails = [];
        let canRestore = false;

        for (const item of checkedItems) {
            const isRestorable = $(item).data('restorable');
            if (isRestorable) {
                canRestore = true;
                const details = $(item).data('details');

                let itemsToRestore = [];
                if (Array.isArray(details.agendamentos)) {
                    itemsToRestore = details.agendamentos;
                } else if (typeof details === 'object' && details !== null && details.senha) {
                    itemsToRestore.push(details);
                }

                for (const singleDetail of itemsToRestore) {
                    if (singleDetail && singleDetail.senha) {
                        const newRascunhoRef = doc(collection(db, "agendamentos-rascunho"));

                        const newRascunhoData = {
                            userId: currentUserUid,
                            senha: singleDetail.senha || null,
                            data: singleDetail.data || null,
                            central: singleDetail.central || null,
                            cargas: singleDetail.cargas || null,
                            pedidoCompra: singleDetail.pedidoCompra || null,
                            fornecedor: singleDetail.fornecedor || null,
                            tipoDeProduto: singleDetail.tipoDeProduto || null,
                            produto: singleDetail.produto || null,
                            volumes: singleDetail.volumes || null,
                            timestamp: new Date()
                        };
                        batch.set(newRascunhoRef, newRascunhoData);
                        restoredDetails.push(newRascunhoData);
                        restoredCount++;
                    }
                }
            }
        }

        if (!canRestore) {
             alert('Nenhum item selecionado pode ser restaurado. Apenas exclusões podem ser restauradas.');
             return;
        }

        if (confirm(`Tem certeza que deseja restaurar ${restoredCount} agendamento(s) para os rascunhos?`)) {
            try {
                await batch.commit();
                await adicionarHistorico(`restaurou ${restoredCount} agendamento(s) do histórico`, { agendamentos: restoredDetails });
                alert(`${restoredCount} agendamento(s) restaurado(s) para os rascunhos com sucesso!`);
            } catch (e) {
                console.error("Erro ao restaurar agendamentos: ", e);
                alert("Ocorreu um erro ao restaurar os agendamentos. Tente novamente.");
            } finally {
                carregarHistorico();
            }
        }
    });

    $('#deleteSelectedBtn').on('click', async () => {
        const checkedItems = $('.historico-checkbox:checked');
        if (checkedItems.length === 0) {
            alert('Por favor, selecione pelo menos um item para excluir.');
            return;
        }

        if (confirm(`Tem certeza que deseja excluir permanentemente ${checkedItems.length} registro(s) do histórico?`)) {
            const batch = writeBatch(db);
            const deletedIds = [];

            checkedItems.each(function() {
                const id = $(this).data('id');
                const docRef = doc(db, "historico-acoes", id);
                batch.delete(docRef);
                deletedIds.push(id);
            });

            try {
                await batch.commit();
                alert(`${deletedIds.length} registro(s) excluído(s) permanentemente do histórico.`);
            } catch (e) {
                console.error("Erro ao excluir registros do histórico: ", e);
                alert("Ocorreu um erro ao excluir os registros. Tente novamente.");
            } finally {
                carregarHistorico();
            }
        }
    });

    async function adicionarHistorico(acao, detalhes) {
        if (!currentUserUid) {
            console.error("Não foi possível adicionar ao histórico. Usuário não logado.");
            return;
        }
        try {
            await addDoc(collection(db, "historico-acoes"), {
                userId: currentUserUid,
                username: currentUserName,
                acao: acao,
                detalhes: detalhes,
                timestamp: new Date()
            });
        } catch (e) {
            console.error("Erro ao adicionar histórico: ", e);
        }
    }
</script>

</body>
</html>
