<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Gerenciamento de Agendamentos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #fafafa; }
    header { text-align: center; margin-bottom: 20px; }
    h1 { color: #cc0000; font-size: 28px; margin: 10px 0 20px 0; font-weight: bold; }
    form { margin-bottom: 20px; padding: 20px; border: 1px solid #ff9999; border-radius: 6px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    input, button { display: block; width: 100%; margin-bottom: 10px; padding: 8px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
    button { background: #d32f2f; color: white; font-weight: bold; cursor: pointer; }
    button:hover { background: #b71c1c; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    thead th { background: #cc0000; color: white; }
    button.edit, button.delete { margin-left: 5px; padding: 5px 10px; font-size: 12px; }
    .table-container { overflow-x: auto; }
    #userBar {
        background: #E6E6E6;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 6px;
        margin-bottom: 12px;
    }
    #exportButtons { margin-bottom: 15px; }
    #exportButtons button { display: inline-block; width: auto; margin-right: 10px; padding: 10px 20px; }
    .filter-input { width: 100%; box-sizing: border-box; }
    #agendamentosTabela_filter { display: none; }
    /* Ajuste para evitar quebra de linha em colunas pequenas */
    #agendamentosTabela td:nth-child(2) { white-space: nowrap; }
  </style>
</head>
<body>

<div id="userBar">
  <button onclick="history.back()" style="
    background: transparent; 
    border: none; 
    color: #333; 
    font-size: 24px; 
    cursor: pointer;
    margin-right: 10px;
  ">←</button>
  <span id="welcomeUser" style="font-weight:bold; color:#333; flex-grow: 1;"></span>
  <button onclick="logout()" style="background:#CC0000; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:bold;">Sair</button>
</div>
<script>
const username = localStorage.getItem("username") || "Usuário";
document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("welcomeUser").textContent = "Bem-vindo, " + username;
});
</script>

<header>
  <h1>Gerenciamento de Agendamentos</h1>
</header>
  
<div class="table-container">
  <form id="agendamentoForm">
    <h2>Adicionar/Editar Agendamento</h2>
    <input type="date" id="data" required>
    <input type="text" id="central" placeholder="Central" required>
    <input type="text" id="cargas" placeholder="Cargas" required>
    <input type="text" id="fornecedor" placeholder="Fornecedor" required>
    <input type="text" id="tipoDeProduto" placeholder="Tipo de Produto" required>
    <input type="text" id="produto" placeholder="Produto" required>
    <button type="submit">Salvar Agendamento</button>
  </form>

  <h2>Lista de Agendamentos</h2>
  <div id="exportButtons">
    <button onclick="exportarExcel()">Exportar Excel</button>
    <button onclick="exportarPDF()">Exportar PDF</button>
  </div>
  <table id="agendamentosTabela" class="display" style="width:100%">
    <thead>
      <tr>
        <th>Senha</th>
        <th>Data</th>
        <th>Central</th>
        <th>Cargas</th>
        <th>Fornecedor</th>
        <th>Tipo de Produto</th>
        <th>Produto</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tfoot>
      <tr>
        <th><input type="text" placeholder="Filtrar Senha" class="filter-input"></th>
        <th><input type="text" placeholder="Filtrar Data" class="filter-input"></th>
        <th><input type="text" placeholder="Filtrar Central" class="filter-input"></th>
        <th><input type="text" placeholder="Filtrar Cargas" class="filter-input"></th>
        <th><input type="text" placeholder="Filtrar Fornecedor" class="filter-input"></th>
        <th><input type="text" placeholder="Filtrar Tipo" class="filter-input"></th>
        <th><input type="text" placeholder="Filtrar Produto" class="filter-input"></th>
        <th></th>
      </tr>
    </tfoot>
    <tbody>
      </tbody>
  </table>
</div>

<script type="module">
  import { db, auth } from "./firebase-config.js";
  import { collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const form = document.getElementById('agendamentoForm');
  const tabelaBody = document.querySelector('#agendamentosTabela tbody');
  let editingId = null;
  let dataTable = null;

  onAuthStateChanged(auth, user => {
    if (!user) {
        window.location.href = "index.html";
    }
  });

  window.logout = () => {
    signOut(auth).then(() => {
        window.location.href = "index.html";
    }).catch((error) => {
        console.error("Erro ao fazer logout: ", error);
    });
  };

  function carregarAgendamentos() {
    onSnapshot(collection(db, "agendamentos"), (snapshot) => {
      const agendamentos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      if (dataTable) {
        dataTable.destroy();
      }

      const dadosParaTabela = agendamentos.map(item => [
        item.senha,
        item.data,
        item.central,
        item.cargas,
        item.fornecedor,
        item.tipoDeProduto,
        item.produto,
        `<button class="edit" data-id="${item.id}">Editar</button> <button class="delete" data-id="${item.id}">Excluir</button>`
      ]);

      dataTable = $('#agendamentosTabela').DataTable({
        data: dadosParaTabela,
        columns: [
          { title: "Senha" },
          { title: "Data" },
          { title: "Central" },
          { title: "Cargas" },
          { title: "Fornecedor" },
          { title: "Tipo de Produto" },
          { title: "Produto" },
          { title: "Ações", orderable: false, searchable: false }
        ],
        paging: false,
        info: false
      });

      // Remove a linha de filtro extra
      $('#agendamentosTabela_wrapper #agendamentosTabela_filter').remove();
      
      // Configura os filtros de coluna no rodapé
      dataTable.columns().eq(0).each(function (colIdx) {
        $('input', dataTable.column(colIdx).footer()).on('keyup change', function () {
            dataTable.column(colIdx).search(this.value).draw();
        });
      });
    });
  }

  // Adiciona/Atualiza um agendamento
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const agendamento = {
      data: form['data'].value,
      central: form['central'].value,
      cargas: form['cargas'].value,
      fornecedor: form['fornecedor'].value,
      tipoDeProduto: form['tipoDeProduto'].value,
      produto: form['produto'].value
    };

    if (editingId) {
      const docRef = doc(db, "agendamentos", editingId);
      await updateDoc(docRef, agendamento);
      editingId = null;
    } else {
      // --- Lógica para gerar a senha sequencial ---
      const contadorRef = doc(db, "metadados", "contador");
      
      try {
        await runTransaction(db, async (transaction) => {
            const contadorDoc = await transaction.get(contadorRef);
            const novaSenha = contadorDoc.data().ultima_senha + 1;
            
            agendamento.senha = novaSenha;

            await addDoc(collection(db, "agendamentos"), agendamento);
            
            transaction.update(contadorRef, { ultima_senha: novaSenha });
        });
      } catch (e) {
          console.error("Erro ao gerar senha e salvar agendamento: ", e);
          alert("Ocorreu um erro ao salvar. Tente novamente.");
      }
    }
    form.reset();
  });

  // Edita ou Exclui um agendamento
  $(document).on('click', '.edit', async function () {
      // Rola a página para o formulário
      document.getElementById('agendamentoForm').scrollIntoView({ behavior: 'smooth' });
      
      editingId = $(this).data('id');
      const docRef = doc(db, "agendamentos", editingId);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const dados = docSnap.data();
        form['data'].value = dados.data;
        form['central'].value = dados.central;
        form['cargas'].value = dados.cargas;
        form['fornecedor'].value = dados.fornecedor;
        form['tipoDeProduto'].value = dados.tipoDeProduto;
        form['produto'].value = dados.produto;
      }
  });

  $(document).on('click', '.delete', async function () {
      const id = $(this).data('id');
      const docRef = doc(db, "agendamentos", id);
      if (confirm("Tem certeza que deseja excluir este agendamento?")) {
        await deleteDoc(docRef);
      }
  });

  // Funções de exportação
  window.exportarPDF = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const headers = ["Senha", "Data", "Central", "Cargas", "Fornecedor", "Tipo de Produto", "Produto"];
    const dadosVisiveis = dataTable.rows({ search: 'applied' }).data().toArray().map(row => row.slice(0, 7));
    doc.autoTable({
      head: [headers],
      body: dadosVisiveis,
    });
    doc.save('agendamentos.pdf');
  };

  window.exportarExcel = () => {
    const headers = ["Senha", "Data", "Central", "Cargas", "Fornecedor", "Tipo de Produto", "Produto"];
    const dadosVisiveis = dataTable.rows({ search: 'applied' }).data().toArray().map(row => row.slice(0, 7));
    const ws_data = [headers, ...dadosVisiveis];
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Agendamentos");
    XLSX.writeFile(wb, "agendamentos.xlsx");
  };

  carregarAgendamentos();
</script>

</body>
</html>
