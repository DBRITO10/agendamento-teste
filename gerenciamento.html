<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Gerenciamento de Agendamentos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #fafafa; }
    header { text-align: center; margin-bottom: 20px; }
    h1 { color: #cc0000; font-size: 28px; margin: 10px 0 20px 0; font-weight: bold; }
    form { margin-bottom: 20px; padding: 20px; border: 1px solid #ff9999; border-radius: 6px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    input, button { display: block; width: 100%; margin-bottom: 10px; padding: 8px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
    button { background: #d32f2f; color: white; font-weight: bold; cursor: pointer; }
    button:hover { background: #b71c1c; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    thead th { background: #cc0000; color: white; position: relative; }
    button.edit, button.delete { margin-left: 5px; padding: 5px 10px; font-size: 12px; }
    .table-container { overflow-x: auto; }
    #userBar {
        background: #E6E6E6;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 6px;
        margin-bottom: 12px;
    }
    #exportButtons { margin-bottom: 15px; }
    #exportButtons button { display: inline-block; width: auto; margin-right: 10px; padding: 10px 20px; }
    #agendamentosTabela_filter { display: none; }
    #agendamentosTabela td:nth-child(2) { white-space: nowrap; }

    /* Estilos do filtro flutuante */
    .filter-button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      margin-left: 5px;
      padding: 0;
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      width: auto;
    }
    .filter-popup {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 10px;
      z-index: 1000;
      min-width: 150px;
      max-height: 200px;
      overflow-y: auto;
    }
    .filter-popup label {
      display: block;
      cursor: pointer;
    }
    .filter-popup label:hover {
      background: #f0f0f0;
    }
    #agendamentosTabela tfoot th {
      background-color: #f2f2f2;
      color: #333;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="userBar">
  <button onclick="history.back()" style="
    background: transparent; 
    border: none; 
    color: #333; 
    font-size: 24px; 
    cursor: pointer;
    margin-right: 10px;
  ">←</button>
  <span id="welcomeUser" style="font-weight:bold; color:#333; flex-grow: 1;"></span>
  <button onclick="logout()" style="background:#CC0000; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:bold;">Sair</button>
</div>
<script>
const username = localStorage.getItem("username") || "Usuário";
document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("welcomeUser").textContent = "Bem-vindo, " + username;
});
</script>

<header>
  <h1>Gerenciamento de Agendamentos</h1>
</header>
  
<div class="table-container">
  <form id="agendamentoForm">
    <h2>Adicionar/Editar Agendamento</h2>
    <input type="date" id="data" required>
    <input type="text" id="central" placeholder="Central" required>
    <input type="text" id="cargas" placeholder="Cargas" required>
    <input type="text" id="fornecedor" placeholder="Fornecedor" required>
    <input type="text" id="tipoDeProduto" placeholder="Tipo de Produto" required>
    <input type="text" id="produto" placeholder="Produto" required>
    <button type="submit">Salvar Agendamento</button>
  </form>

  <h2>Lista de Agendamentos</h2>
  <div id="exportButtons">
    <button onclick="exportarExcel()">Exportar Excel</button>
    <button onclick="exportarPDF()">Exportar PDF</button>
  </div>
  <table id="agendamentosTabela" class="display" style="width:100%">
    <thead>
      <tr>
        <th>Senha</th>
        <th>Data <button class="filter-button" data-col="data">▼</button></th>
        <th>Central <button class="filter-button" data-col="central">▼</button></th>
        <th>Cargas <button class="filter-button" data-col="cargas">▼</button></th>
        <th>Fornecedor <button class="filter-button" data-col="fornecedor">▼</button></th>
        <th>Tipo de Produto <button class="filter-button" data-col="tipoDeProduto">▼</button></th>
        <th>Produto <button class="filter-button" data-col="produto">▼</button></th>
        <th>Ações</th>
      </tr>
    </thead>
    <tfoot>
      <tr>
        <th></th>
        <th></th>
        <th></th>
        <th id="totalCargas">Total: 0</th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
      </tr>
    </tfoot>
    <tbody>
      </tbody>
  </table>
  <div id="filter-popup-container"></div>
</div>

<script type="module">
  import { db, auth } from "./firebase-config.js";
  import { collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const form = document.getElementById('agendamentoForm');
  let editingId = null;
  let dataTable = null;

  onAuthStateChanged(auth, user => {
    if (!user) {
        window.location.href = "index.html";
    }
  });

  window.logout = () => {
    signOut(auth).then(() => {
        window.location.href = "index.html";
    }).catch((error) => {
        console.error("Erro ao fazer logout: ", error);
    });
  };

  function carregarAgendamentos() {
    onSnapshot(collection(db, "agendamentos"), (snapshot) => {
      const agendamentos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      if (dataTable) {
        dataTable.destroy();
      }

      const dadosParaTabela = agendamentos.map(item => [
        item.senha,
        item.data,
        item.central,
        item.cargas,
        item.fornecedor,
        item.tipoDeProduto,
        item.produto,
        `<button class="edit" data-id="${item.id}">Editar</button> <button class="delete" data-id="${item.id}">Excluir</button>`
      ]);

      dataTable = $('#agendamentosTabela').DataTable({
        data: dadosParaTabela,
        columns: [
          { title: "Senha" },
          { title: "Data" },
          { title: "Central" },
          { title: "Cargas" },
          { title: "Fornecedor" },
          { title: "Tipo de Produto" },
          { title: "Produto" },
          { title: "Ações", orderable: false, searchable: false }
        ],
        paging: false,
        info: false,
        order: [],
      });

      // Recalcula o total de cargas após cada filtro, ordenação ou redesenho
      dataTable.on('draw.dt', function () {
        atualizarTotalCargas();
      });
      atualizarTotalCargas();
    });
  }

  // Lógica para o filtro de botão
  const filterPopupContainer = document.getElementById('filter-popup-container');
  const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

  $(document).on('click', '.filter-button', function (e) {
    e.stopPropagation();
    const columnIndex = dataTable.column($(this).closest('th')).index();
    const columnData = dataTable.column(columnIndex, { search: 'applied' }).data();
    
    // Constrói o HTML do popup
    let popupHtml = '<div><label><input type="radio" name="filter-radio" value="" checked> Todos</label></div>';
    
    let uniqueValues;
    if (columnIndex === 1) { // Coluna da Data
        uniqueValues = columnData.map(d => {
            const date = new Date(d + "T00:00:00");
            const month = date.getMonth();
            const year = date.getFullYear();
            return `${monthNames[month]}/${year}`;
        }).unique().sort();
    } else {
        uniqueValues = columnData.unique().sort();
    }
    
    uniqueValues.each(value => {
        popupHtml += `<div><label><input type="radio" name="filter-radio" value="${value}"> ${value}</label></div>`;
    });
    
    filterPopupContainer.innerHTML = popupHtml;
    const buttonRect = this.getBoundingClientRect();
    filterPopupContainer.style.top = `${buttonRect.bottom + window.scrollY}px`;
    filterPopupContainer.style.left = `${buttonRect.left}px`;
    filterPopupContainer.classList.add('filter-popup');
    
    // Aplica o filtro quando uma opção é clicada no popup
    $(filterPopupContainer).on('change', 'input', function () {
        const selectedValue = $(this).val();
        if (columnIndex === 1) { // Coluna da Data
            if (selectedValue === "") {
                dataTable.column(columnIndex).search("").draw();
            } else {
                const [selectedMonth, selectedYear] = selectedValue.split('/');
                const monthIndex = monthNames.indexOf(selectedMonth);
                const searchRegex = `^\\d{4}-${(monthIndex + 1).toString().padStart(2, '0')}-\\d{2}$`;
                dataTable.column(columnIndex).search(searchRegex, true, false).draw();
            }
        } else {
            dataTable.column(columnIndex).search(selectedValue).draw();
        }
        filterPopupContainer.classList.remove('filter-popup');
        filterPopupContainer.innerHTML = '';
        $(filterPopupContainer).off('change'); // Remove o listener para evitar duplicação
    });
  });

  // Esconde o popup ao clicar fora
  $(document).on('click', function (e) {
    if (!$(e.target).closest('.filter-popup').length && !$(e.target).hasClass('filter-button')) {
      filterPopupContainer.classList.remove('filter-popup');
      filterPopupContainer.innerHTML = '';
    }
  });

  // Função para atualizar o total de cargas
  function atualizarTotalCargas() {
    const total = dataTable.column(3, { page: 'current' }).data().reduce(function (a, b) {
        const value = parseFloat(b.replace(',', '.')) || 0;
        return a + value;
    }, 0);
    $('#totalCargas').text('Total: ' + total.toFixed(2));
  }

  // Adiciona/Atualiza um agendamento
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const cargasValue = form['cargas'].value.replace('.', '').replace(',', '.');

    const agendamento = {
      data: form['data'].value,
      central: form['central'].value,
      cargas: cargasValue,
      fornecedor: form['fornecedor'].value,
      tipoDeProduto: form['tipoDeProduto'].value,
      produto: form['produto'].value
    };

    if (editingId) {
      const docRef = doc(db, "agendamentos", editingId);
      await updateDoc(docRef, agendamento);
      editingId = null;
    } else {
      const contadorRef = doc(db, "metadados", "contador");
      
      try {
        await runTransaction(db, async (transaction) => {
            const contadorDoc = await transaction.get(contadorRef);
            const novaSenha = contadorDoc.data().ultima_senha + 1;
            
            agendamento.senha = novaSenha;

            await addDoc(collection(db, "agendamentos"), agendamento);
            
            transaction.update(contadorRef, { ultima_senha: novaSenha });
        });
      } catch (e) {
          console.error("Erro ao gerar senha e salvar agendamento: ", e);
          alert("Ocorreu um erro ao salvar. Tente novamente.");
      }
    }
    form.reset();
  });

  // Edita ou Exclui um agendamento
  $(document).on('click', '.edit', async function () {
      document.getElementById('agendamentoForm').scrollIntoView({ behavior: 'smooth' });
      
      editingId = $(this).data('id');
      const docRef = doc(db, "agendamentos", editingId);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const dados = docSnap.data();
        form['data'].value = dados.data;
        form['central'].value = dados.central;
        form['cargas'].value = dados.cargas;
        form['fornecedor'].value = dados.fornecedor;
        form['tipoDeProduto'].value = dados.tipoDeProduto;
        form['produto'].value = dados.produto;
      }
  });

  $(document).on('click', '.delete', async function () {
      const id = $(this).data('id');
      const docRef = doc(db, "agendamentos", id);
      if (confirm("Tem certeza que deseja excluir este agendamento?")) {
        await deleteDoc(docRef);
      }
  });

  // Funções de exportação
  window.exportarPDF = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const headers = ["Senha", "Data", "Central", "Cargas", "Fornecedor", "Tipo de Produto", "Produto"];
    const dadosVisiveis = dataTable.rows({ search: 'applied' }).data().toArray().map(row => row.slice(0, 7));
    doc.autoTable({
      head: [headers],
      body: dadosVisiveis,
    });
    doc.save('agendamentos.pdf');
  };

  window.exportarExcel = () => {
    const headers = ["Senha", "Data", "Central", "Cargas", "Fornecedor", "Tipo de Produto", "Produto"];
    const dadosVisiveis = dataTable.rows({ search: 'applied' }).data().toArray().map(row => row.slice(0, 7));
    const ws_data = [headers, ...dadosVisiveis];
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Agendamentos");
    XLSX.writeFile(wb, "agendamentos.xlsx");
  };

  carregarAgendamentos();
</script>

</body>
</html>
