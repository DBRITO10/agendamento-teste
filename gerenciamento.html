<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Gerenciamento de Agendamentos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #fafafa; }
    header { text-align: center; margin-bottom: 20px; }
    h1 { color: #cc0000; font-size: 28px; margin: 10px 0 20px 0; font-weight: bold; }
    form { margin-bottom: 20px; padding: 20px; border: 1px solid #ff9999; border-radius: 6px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    input, button { display: block; width: 100%; margin-bottom: 10px; padding: 8px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
    button { background: #d32f2f; color: white; font-weight: bold; cursor: pointer; }
    button.rascunho { background: #ff9933; }
    button.rascunho:hover { background: #e68a00; }
    button:hover { background: #b71c1c; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    thead th { background: #cc0000; color: white; position: relative; }
    button.edit, button.delete { margin-left: 5px; padding: 5px 10px; font-size: 12px; }
    .table-container { overflow-x: auto; }
    #userBar {
        background: #E6E6E6;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 6px;
        margin-bottom: 12px;
    }
    #exportButtons { margin-bottom: 15px; }
    #exportButtons button { display: inline-block; width: auto; margin-right: 10px; padding: 10px 20px; }
    #agendamentosTabela_filter { display: none; }
    /* Estilos do filtro flutuante */
    .filter-button-text {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      margin-left: 5px;
      padding: 0;
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      width: auto;
    }
    .filter-popup {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 10px;
      z-index: 1000;
      min-width: 150px;
      max-height: 200px;
      overflow-y: auto;
    }
    .filter-popup label {
      display: block;
      cursor: pointer;
    }
    .filter-popup label:hover {
      background: #f0f0f0;
    }
    #rascunhos-container, #historico-container {
      margin-top: 30px;
      padding: 20px;
      border: 1px solid #ff9999;
      border-radius: 6px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .rascunho-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .rascunho-item:last-child {
      border-bottom: none;
    }
    .rascunho-item button {
      display: inline-block;
      width: auto;
      margin-right: 10px;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
        padding-top: 60px;
    }
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 10px;
    }
    .close-modal {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close-modal:hover, .close-modal:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    footer {
        text-align: center;
        margin-top: 20px;
        padding: 10px;
        border-top: 1px solid #ccc;
        font-size: 14px;
        color: #666;
    }
    #cargasHeader, .carga-item {
        display: flex;
        flex-wrap: nowrap;
        gap: 10px;
        margin-bottom: 10px;
        padding: 5px;
        background: #f5f5f5;
        border-radius: 4px;
        overflow-x: auto;
    }
    .carga-item input {
        flex: 1;
        min-width: 120px;
        margin-bottom: 0;
    }
    #cargasHeader span {
        flex: 1;
        font-weight: bold;
        text-align: center;
        min-width: 120px;
    }
  </style>
</head>
<body>

<div id="userBar">
  <button onclick="history.back()" style="
    background: transparent; 
    border: none; 
    color: #333; 
    font-size: 24px; 
    cursor: pointer;
    margin-right: 10px;
  ">←</button>
  <span id="welcomeUser" style="font-weight:bold; color:#333; flex-grow: 1;"></span>
  <button onclick="logout()" style="background:#CC0000; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:bold;">Sair</button>
</div>
<script>
const username = localStorage.getItem("username") || "Usuário";
document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("welcomeUser").textContent = "Bem-vindo, " + username;
});
</script>

<header>
  <h1>Gerenciamento de Agendamentos</h1>
</header>
  
<div class="table-container">
  <form id="agendamentoForm">
    <h2>Adicionar/Editar Agendamento</h2>
    <input type="number" id="numCargas" placeholder="Número de cargas" min="1" value="1" required>
    <div id="cargasHeader">
      <span>Data</span>
      <span>Central</span>
      <span>Cargas</span>
      <span>Pedido</span>
      <span>Fornecedor</span>
      <span>Tipo de Produto</span>
      <span>Produto</span>
    </div>
    <div id="cargasContainer">
        <div class="carga-item">
            <input type="date" class="data" required>
            <input type="text" class="central" placeholder="Central" required>
            <input type="text" class="cargas" placeholder="Cargas" required>
            <input type="text" class="pedido" placeholder="Pedido" required>
            <input type="text" class="fornecedor" placeholder="Fornecedor" required>
            <input type="text" class="tipoDeProduto" placeholder="Tipo de Produto" required>
            <input type="text" class="produto" placeholder="Produto" required>
        </div>
    </div>
    <button type="submit" id="salvarBtn">Salvar Agendamento</button>
    <button type="button" id="rascunhoBtn" class="rascunho">Salvar em Rascunho</button>
  </form>
  
  <div id="rascunhos-container">
      <h2>Agendamentos em Rascunho</h2>
      <div id="listaRascunhos"></div>
  </div>
  
  <h2>Lista de Agendamentos</h2>
  <div id="exportButtons">
    <button onclick="exportarExcel()">Exportar Excel</button>
    <button onclick="exportarPDF()">Exportar PDF</button>
    <button onclick="abrirHistorico()">Ver Histórico</button>
  </div>
  <table id="agendamentosTabela" class="display" style="width:100%">
    <thead>
      <tr>
        <th>SENHA <span class="filter-button-text">Filtrar</span></th>
        <th>DATA <span class="filter-button-text">Filtrar</span></th>
        <th>CENTRAL <span class="filter-button-text">Filtrar</span></th>
        <th>CARGAS <span class="filter-button-text">Filtrar</span></th>
        <th>PEDIDO <span class="filter-button-text">Filtrar</span></th>
        <th>FORNECEDOR <span class="filter-button-text">Filtrar</span></th>
        <th>TIPO DE PRODUTO <span class="filter-button-text">Filtrar</span></th>
        <th>PRODUTO <span class="filter-button-text">Filtrar</span></th>
        <th>AÇÕES</th>
      </tr>
    </thead>
    <tbody>
      </tbody>
  </table>
  <div id="filter-popup-container"></div>
</div>

<footer>
    <p>Total de Registros: <span id="totalCargas">0</span></p>
</footer>

<div id="historicoModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Histórico de Ações</h2>
        <div id="historicoContent"></div>
    </div>
</div>

<script type="module">
  import { db, auth } from "./firebase-config.js";
  import { collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, getDoc, runTransaction, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const form = document.getElementById('agendamentoForm');
  const numCargasInput = document.getElementById('numCargas');
  const cargasContainer = document.getElementById('cargasContainer');
  const listaRascunhos = document.getElementById('listaRascunhos');
  const totalCargasSpan = document.getElementById('totalCargas');
  const historicoModal = document.getElementById('historicoModal');
  const historicoContent = document.getElementById('historicoContent');
  
  let editingId = null;
  let dataTable = null;
  let currentUserUid = null;

  onAuthStateChanged(auth, user => {
    if (user) {
        currentUserUid = user.uid;
        carregarAgendamentos();
        carregarRascunhos();
    } else {
        window.location.href = "index.html";
    }
  });

  window.logout = () => {
    signOut(auth).then(() => {
        window.location.href = "index.html";
    }).catch((error) => {
        console.error("Erro ao fazer logout: ", error);
    });
  };

  // Funções para o Formulário Dinâmico
  numCargasInput.addEventListener('input', (e) => {
    const numCargas = parseInt(e.target.value) || 1;
    cargasContainer.innerHTML = '';
    for (let i = 0; i < numCargas; i++) {
      cargasContainer.innerHTML += `
        <div class="carga-item">
            <input type="date" class="data" required>
            <input type="text" class="central" placeholder="Central" required>
            <input type="text" class="cargas" placeholder="Cargas" required>
            <input type="text" class="pedido" placeholder="Pedido" required>
            <input type="text" class="fornecedor" placeholder="Fornecedor" required>
            <input type="text" class="tipoDeProduto" placeholder="Tipo de Produto" required>
            <input type="text" class="produto" placeholder="Produto" required>
        </div>
      `;
    }
  });
  
  numCargasInput.dispatchEvent(new Event('input'));

  // Salvar Agendamento em Rascunho
  document.getElementById('rascunhoBtn').addEventListener('click', async () => {
    if (!currentUserUid) {
        alert("Sua sessão expirou. Por favor, faça login novamente.");
        return;
    }
    const cargas = [];
    const cargaItems = document.querySelectorAll('.carga-item');
    let formIncomplete = false;
    cargaItems.forEach(item => {
      const central = item.querySelector('.central').value;
      const carga = item.querySelector('.cargas').value;
      const pedido = item.querySelector('.pedido').value;
      if (!central || !carga) {
        formIncomplete = true;
      }
      cargas.push({
        data: item.querySelector('.data').value || null,
        central: central,
        cargas: carga,
        pedido: pedido,
        fornecedor: item.querySelector('.fornecedor').value,
        tipoDeProduto: item.querySelector('.tipoDeProduto').value,
        produto: item.querySelector('.produto').value
      });
    });

    if (formIncomplete) {
      alert("Por favor, preencha pelo menos os campos Central e Cargas.");
      return;
    }

    try {
      await addDoc(collection(db, "agendamentos-rascunho"), {
        userId: currentUserUid,
        cargas: cargas,
        timestamp: new Date()
      });
      alert('Agendamento salvo como rascunho!');
      form.reset();
      numCargasInput.value = 1;
      numCargasInput.dispatchEvent(new Event('input'));
    } catch (e) {
      console.error("Erro ao salvar rascunho: ", e);
      alert('Erro ao salvar rascunho. Tente novamente.');
    }
  });

  // Carregar Rascunhos do Firestore
  function carregarRascunhos() {
    if (!currentUserUid) return;
    const q = query(collection(db, "agendamentos-rascunho"), where("userId", "==", currentUserUid));
    onSnapshot(q, (snapshot) => {
      listaRascunhos.innerHTML = '';
      snapshot.forEach(doc => {
        const rascunho = doc.data();
        const rascunhoDiv = document.createElement('div');
        rascunhoDiv.classList.add('rascunho-item');
        
        let rascunhoContent = `<p><strong>ID do rascunho:</strong> ${doc.id}</p>`;
        rascunho.cargas.forEach((carga, index) => {
            rascunhoContent += `<p><strong>Carga ${index + 1}:</strong> Data: ${carga.data || "Não definida"}, Central: ${carga.central}, Produto: ${carga.produto}</p>`;
        });
        
        rascunhoDiv.innerHTML = rascunhoContent;
        
        const copiarBtn = document.createElement('button');
        copiarBtn.textContent = 'Copiar Dados para o Formulário';
        copiarBtn.onclick = () => {
          document.getElementById('agendamentoForm').scrollIntoView({ behavior: 'smooth' });
          numCargasInput.value = rascunho.cargas.length;
          numCargasInput.dispatchEvent(new Event('input'));
          const cargaItems = document.querySelectorAll('.carga-item');
          rascunho.cargas.forEach((carga, index) => {
              if (cargaItems[index]) {
                  cargaItems[index].querySelector('.data').value = carga.data;
                  cargaItems[index].querySelector('.central').value = carga.central;
                  cargaItems[index].querySelector('.cargas').value = carga.cargas;
                  cargaItems[index].querySelector('.pedido').value = carga.pedido;
                  cargaItems[index].querySelector('.fornecedor').value = carga.fornecedor;
                  cargaItems[index].querySelector('.tipoDeProduto').value = carga.tipoDeProduto;
                  cargaItems[index].querySelector('.produto').value = carga.produto;
              }
          });
        };
        rascunhoDiv.appendChild(copiarBtn);

        const deletarRascunhoBtn = document.createElement('button');
        deletarRascunhoBtn.textContent = 'Excluir Rascunho';
        deletarRascunhoBtn.onclick = async () => {
            if (confirm("Tem certeza que deseja excluir este rascunho?")) {
                const docRef = doc(db, "agendamentos-rascunho", doc.id);
                await deleteDoc(docRef);
            }
        };
        rascunhoDiv.appendChild(deletarRascunhoBtn);
        
        listaRascunhos.appendChild(rascunhoDiv);
      });
    });
  }

  function carregarAgendamentos() {
    onSnapshot(collection(db, "agendamentos"), (snapshot) => {
      const agendamentos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      if (dataTable) {
        dataTable.destroy();
      }

      const dadosParaTabela = [];
      let totalCargasCount = 0;
      agendamentos.forEach(agendamento => {
          agendamento.cargas.forEach(carga => {
              dadosParaTabela.push([
                  agendamento.senha,
                  carga.data,
                  carga.central,
                  carga.cargas,
                  carga.pedido,
                  carga.fornecedor,
                  carga.tipoDeProduto,
                  carga.produto,
                  `<button class="edit" data-id="${agendamento.id}">Editar</button> <button class="delete" data-id="${agendamento.id}">Excluir</button>`
              ]);
          });
          totalCargasCount += agendamento.cargas.length;
      });

      dataTable = $('#agendamentosTabela').DataTable({
        data: dadosParaTabela,
        columns: [
          { title: "SENHA" },
          { title: "DATA" },
          { title: "CENTRAL" },
          { title: "CARGAS" },
          { title: "PEDIDO" },
          { title: "FORNECEDOR" },
          { title: "TIPO DE PRODUTO" },
          { title: "PRODUTO" },
          { title: "AÇÕES", orderable: false, searchable: false }
        ],
        paging: false,
        info: false,
        order: [[1, 'asc']]
      });
      // Atualiza os textos dos botões de filtro
      $('.filter-button-text').each(function() {
        const columnIndex = dataTable.column($(this).closest('th')).index();
        const searchTerm = dataTable.column(columnIndex).search();
        $(this).text(searchTerm ? 'APLICADO' : 'Filtrar');
      });
      // Atualiza o total de cargas no rodapé
      totalCargasSpan.textContent = totalCargasCount;
    });
  }

  // Lógica de filtro avançada
  const filterPopupContainer = document.getElementById('filter-popup-container');
  let activeColumnIndex = null;
  let activeFilterButton = null;
  
  $(document).on('click', '.filter-button-text', function (e) {
    e.stopPropagation();
    activeFilterButton = $(this);
    const columnIndex = dataTable.column($(this).closest('th')).index();
    const columnData = dataTable.column(columnIndex, { search: 'applied' }).data().unique().sort();
    
    let popupHtml = '<div><label><input type="radio" name="filter-radio" value="" checked> Todos</label></div>';
    columnData.each(value => {
        popupHtml += `<div><label><input type="radio" name="filter-radio" value="${value}"> ${value}</label></div>`;
    });
    
    filterPopupContainer.innerHTML = popupHtml;
    const buttonRect = this.getBoundingClientRect();
    filterPopupContainer.style.top = `${buttonRect.bottom + window.scrollY}px`;
    filterPopupContainer.style.left = `${buttonRect.left}px`;
    filterPopupContainer.classList.add('filter-popup');

    activeColumnIndex = columnIndex;
  });

  $(document).on('change', '.filter-popup input', function () {
    const value = $(this).val();
    dataTable.column(activeColumnIndex).search(value).draw();
    if (activeFilterButton) {
        activeFilterButton.text(value ? 'APLICADO' : 'Filtrar');
    }
    filterPopupContainer.classList.remove('filter-popup');
    filterPopupContainer.innerHTML = '';
  });

  $(document).on('click', function (e) {
    if (!$(e.target).closest('.filter-popup').length && !$(e.target).hasClass('filter-button-text')) {
      filterPopupContainer.classList.remove('filter-popup');
      filterPopupContainer.innerHTML = '';
    }
  });

  // Adiciona/Atualiza um agendamento e registra no histórico
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const agendamento = {
        cargas: [],
        timestamp: new Date()
    };
    
    const cargaItems = document.querySelectorAll('.carga-item');
    let formIncomplete = false;
    
    cargaItems.forEach(item => {
      const data = item.querySelector('.data').value;
      const central = item.querySelector('.central').value;
      const cargas = item.querySelector('.cargas').value;
      const pedido = item.querySelector('.pedido').value;
      
      if (!data || !central || !cargas) {
        formIncomplete = true;
      }
      agendamento.cargas.push({
        data: data,
        central: central,
        cargas: cargas,
        pedido: pedido,
        fornecedor: item.querySelector('.fornecedor').value,
        tipoDeProduto: item.querySelector('.tipoDeProduto').value,
        produto: item.querySelector('.produto').value
      });
    });
    
    if (formIncomplete) {
      alert("Por favor, preencha todos os campos obrigatórios (Data, Central e Cargas).");
      return;
    }

    if (editingId) {
      // Editar um agendamento existente
      const docRef = doc(db, "agendamentos", editingId);
      await updateDoc(docRef, { cargas: agendamento.cargas });
      await adicionarHistorico("editou um agendamento", { id: editingId, cargas: agendamento.cargas });
      editingId = null;
    } else {
      // Criar um novo agendamento com todas as cargas em um único documento
      const contadorRef = doc(db, "metadados", "contador");
      try {
          await runTransaction(db, async (transaction) => {
              const contadorDoc = await transaction.get(contadorRef);
              let novaSenha = 1;
              if (contadorDoc.exists()) {
                  novaSenha = contadorDoc.data().ultima_senha + 1;
              }
              agendamento.senha = novaSenha;
              const newDocRef = doc(collection(db, "agendamentos"));
              transaction.set(newDocRef, agendamento);
              transaction.set(contadorRef, { ultima_senha: novaSenha });
              await adicionarHistorico("agendou um novo carro", { id: newDocRef.id, ...agendamento });
          });
      } catch (e) {
          console.error("Erro ao gerar senha e salvar agendamento: ", e);
          alert("Ocorreu um erro ao salvar. Tente novamente.");
      }
    }
    form.reset();
    numCargasInput.value = 1;
    numCargasInput.dispatchEvent(new Event('input'));
  });

  // Edita ou Exclui um agendamento
  $(document).on('click', '.edit', async function () {
      document.getElementById('agendamentoForm').scrollIntoView({ behavior: 'smooth' });
      editingId = $(this).data('id');
      const docRef = doc(db, "agendamentos", editingId);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const dados = docSnap.data();
        numCargasInput.value = dados.cargas.length;
        numCargasInput.dispatchEvent(new Event('input'));
        
        const cargaItems = document.querySelectorAll('.carga-item');
        dados.cargas.forEach((carga, index) => {
            if (cargaItems[index]) {
                cargaItems[index].querySelector('.data').value = carga.data;
                cargaItems[index].querySelector('.central').value = carga.central;
                cargaItems[index].querySelector('.cargas').value = carga.cargas;
                cargaItems[index].querySelector('.pedido').value = carga.pedido;
                cargaItems[index].querySelector('.fornecedor').value = carga.fornecedor;
                cargaItems[index].querySelector('.tipoDeProduto').value = carga.tipoDeProduto;
                cargaItems[index].querySelector('.produto').value = carga.produto;
            }
        });
      }
  });

  $(document).on('click', '.delete', async function () {
      const id = $(this).data('id');
      const docRef = doc(db, "agendamentos", id);
      if (confirm("Tem certeza que deseja excluir este agendamento?")) {
        await deleteDoc(docRef);
        await adicionarHistorico("excluiu um agendamento", { id: id });
      }
  });

  // Funções de exportação
  window.exportarPDF = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const headers = ["SENHA", "DATA", "CENTRAL", "CARGAS", "PEDIDO", "FORNECEDOR", "TIPO DE PRODUTO", "PRODUTO"];
    const dadosVisiveis = dataTable.rows({ search: 'applied' }).data().toArray().map(row => row.slice(0, 8));
    doc.autoTable({
      head: [headers],
      body: dadosVisiveis,
    });
    doc.save('agendamentos.pdf');
  };

  window.exportarExcel = () => {
    const headers = ["SENHA", "DATA", "CENTRAL", "CARGAS", "PEDIDO", "FORNECEDOR", "TIPO DE PRODUTO", "PRODUTO"];
    const dadosVisiveis = dataTable.rows({ search: 'applied' }).data().toArray().map(row => row.slice(0, 8));
    const ws_data = [headers, ...dadosVisiveis];
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Agendamentos");
    XLSX.writeFile(wb, "agendamentos.xlsx");
  };

  // Histórico de Ações
  async function adicionarHistorico(acao, detalhes) {
      if (!currentUserUid) return;
      await addDoc(collection(db, "historico-acoes"), {
          userId: currentUserUid,
          username: localStorage.getItem("username"),
          acao: acao,
          detalhes: detalhes,
          timestamp: new Date()
      });
  }

  window.abrirHistorico = async () => {
      historicoContent.innerHTML = 'Carregando...';
      const q = query(collection(db, "historico-acoes"), where("userId", "==", currentUserUid));
      const snapshot = await getDocs(q);
      historicoContent.innerHTML = '';
      if (snapshot.empty) {
          historicoContent.innerHTML = '<p>Nenhuma ação registrada.</p>';
      } else {
          snapshot.forEach(doc => {
              const acao = doc.data();
              const data = new Date(acao.timestamp.seconds * 1000).toLocaleString();
              historicoContent.innerHTML += `<p><strong>${data}</strong>: Você ${acao.acao} (ID: ${acao.detalhes.id}).</p>`;
          });
      }
      historicoModal.style.display = 'block';
  };

  document.querySelector('.close-modal').onclick = () => {
      historicoModal.style.display = 'none';
  };

  window.onclick = (event) => {
      if (event.target == historicoModal) {
          historicoModal.style.display = 'none';
      }
  };
</script>

</body>
</html>
